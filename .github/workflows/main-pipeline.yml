name: Main DevOps Pipeline

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      force_ami_creation:
        description: 'Force AMI creation even if exists'
        required: false
        type: boolean
        default: false
      update_instances:
        description: 'Update running EC2 instances after deployment'
        required: false
        type: boolean
        default: false
      environment:
        description: 'Target environment for deployment'
        required: false
        type: choice
        options:
          - staging
          - production
        default: staging

permissions:
  contents: write
  packages: write
  security-events: write
  deployments: write
  actions: read
  pull-requests: write
  checks: write

jobs:
  # ETAPA 1: BUILD DE IMAGEN
  build-stage:
    name: "ðŸ—ï¸ Stage 1: Build Container Image"
    uses: ./.github/workflows/build_rhel_bootc.yml
    secrets: inherit

  # ETAPA 2: SECURITY, QUALITY & TESTING (EN PARALELO)
  security-stage:
    name: "ðŸ”’ Stage 2a: Security Scanning"
    needs: build-stage
    uses: ./.github/workflows/security-scan.yml
    secrets: inherit

  quality-stage:
    name: "ðŸ“Š Stage 2b: Code Quality Analysis"
    needs: build-stage
    uses: ./.github/workflows/code-quality.yml
    secrets: inherit


  # ETAPA 3: QUALITY GATE
  quality-gate:
    name: "ðŸš¦ Stage 3: Quality Gate"
    runs-on: ubuntu-latest
    needs: [build-stage, security-stage, quality-stage]
    if: always()
    outputs:
      gate_passed: ${{ steps.gate-check.outputs.gate_passed }}
      
    steps:
      - name: Evaluate Quality Gate
        id: gate-check
        run: |
          echo "## ðŸš¦ Quality Gate Results" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build-stage.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security | ${{ needs.security-stage.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Quality | ${{ needs.quality-stage.result }} |" >> $GITHUB_STEP_SUMMARY
          
          # Critical checks (must pass)
          CRITICAL_FAILED=false
          
          if [ "${{ needs.build-stage.result }}" != "success" ]; then
            echo "âŒ **CRITICAL**: Build stage failed" >> $GITHUB_STEP_SUMMARY
            CRITICAL_FAILED=true
          fi
          
          if [ "${{ needs.security-stage.result }}" == "failure" ]; then
            echo "âŒ **CRITICAL**: Security stage failed" >> $GITHUB_STEP_SUMMARY  
            CRITICAL_FAILED=true
          fi
          
          # Also fail on cancelled or skipped critical stages
          if [ "${{ needs.build-stage.result }}" == "cancelled" ] || [ "${{ needs.build-stage.result }}" == "skipped" ]; then
            echo "âŒ **CRITICAL**: Build stage was cancelled or skipped" >> $GITHUB_STEP_SUMMARY
            CRITICAL_FAILED=true
          fi
          
          if [ "${{ needs.security-stage.result }}" == "cancelled" ] || [ "${{ needs.security-stage.result }}" == "skipped" ]; then
            echo "âŒ **CRITICAL**: Security stage was cancelled or skipped" >> $GITHUB_STEP_SUMMARY  
            CRITICAL_FAILED=true
          fi
          
          # Warning checks (can proceed with warnings)
          if [ "${{ needs.quality-stage.result }}" == "failure" ]; then
            echo "âš ï¸ **WARNING**: Quality stage failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          
          # Decision logic
          if [ "$CRITICAL_FAILED" = "true" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ›‘ **QUALITY GATE: FAILED**" >> $GITHUB_STEP_SUMMARY
            echo "Critical issues detected. Deployment blocked." >> $GITHUB_STEP_SUMMARY
            echo "gate_passed=false" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… **QUALITY GATE: PASSED**" >> $GITHUB_STEP_SUMMARY
            echo "All critical checks passed. Proceeding to deployment." >> $GITHUB_STEP_SUMMARY
            echo "gate_passed=true" >> $GITHUB_OUTPUT
          fi

  # ETAPA 4: DEPLOYMENT
  deployment-stage:
    name: "ðŸš€ Stage 4: Deployment"
    needs: [build-stage, quality-gate]
    if: needs.quality-gate.outputs.gate_passed == 'true'
    uses: ./.github/workflows/create_ami.yml
    with:
      image_tag: ${{ needs.build-stage.outputs.image_tag }}
      ami_name_override: ${{ vars.AMI_NAME_PREFIX }}-${{ needs.build-stage.outputs.image_tag }}
      force_ami_creation: ${{ inputs.force_ami_creation || false }}
      update_running_instances: ${{ inputs.update_instances || false }}
    secrets: inherit

  # ETAPA 5: POST-DEPLOYMENT (si es release)
  post-deployment:
    name: "ðŸ“‹ Stage 5: Post-Deployment"
    runs-on: ubuntu-latest
    needs: [build-stage, quality-gate, deployment-stage]
    if: always() && needs.deployment-stage.result == 'success'
    environment:
      name: ${{ inputs.environment || 'staging' }}
      
    steps:
      - name: Generate deployment summary
        run: |
          echo "## ðŸŽ‰ Pipeline Execution Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Execution Summary:" >> $GITHUB_STEP_SUMMARY
          echo "- **Build**: âœ… Container image created" >> $GITHUB_STEP_SUMMARY
          echo "- **Security**: âœ… Scanned and reports available" >> $GITHUB_STEP_SUMMARY
          echo "- **Quality**: âœ… Code quality checked" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployment**: âœ… AMI created and available" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ Deployment Details:" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ inputs.environment || 'staging' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Tag**: ${{ needs.build-stage.outputs.image_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Container**: ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}:${{ needs.build-stage.outputs.image_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **AMI**: Available in AWS EC2 Console" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Check **Security** tab for vulnerability reports" >> $GITHUB_STEP_SUMMARY
          echo "2. Verify **AMI** is available in AWS EC2 Console" >> $GITHUB_STEP_SUMMARY
          echo "3. Launch EC2 instances using the created AMI" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ inputs.update_instances }}" == "true" ]; then
            echo "4. âœ… Running instances have been updated" >> $GITHUB_STEP_SUMMARY
          else
            echo "4. Optionally run \`update-instances.yml\` to update running instances" >> $GITHUB_STEP_SUMMARY
          fi

  # PIPELINE STATUS FINAL
  pipeline-status:
    name: "ðŸ“ˆ Pipeline Status"
    runs-on: ubuntu-latest
    needs: [build-stage, security-stage, quality-stage, quality-gate, deployment-stage]
    if: always()
    
    steps:
      - name: Final pipeline status
        run: |
          echo "## ðŸ“ˆ Final Pipeline Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Stage Results:" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status | Duration |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ—ï¸ Build | ${{ needs.build-stage.result }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”’ Security | ${{ needs.security-stage.result }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“Š Quality | ${{ needs.quality-stage.result }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸš¦ Quality Gate | ${{ needs.quality-gate.result }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸš€ Deployment | ${{ needs.deployment-stage.result }} | - |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Overall status
          if [ "${{ needs.deployment-stage.result }}" == "success" ]; then
            echo "ðŸŽ‰ **PIPELINE: SUCCESS** - All stages completed successfully!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… **Ready for production use**" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.quality-gate.result }}" == "failure" ]; then
            echo "ðŸ›‘ **PIPELINE: BLOCKED** - Quality gate failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âŒ **Deployment blocked due to quality issues**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **PIPELINE: PARTIAL** - Some non-critical issues detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ **Review issues before production deployment**" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Set final exit code based on critical failures
          PIPELINE_FAILED=false
          
          # Check if deployment failed
          if [ "${{ needs.deployment-stage.result }}" == "failure" ]; then
            echo "ðŸ›‘ **PIPELINE FAILED**: Deployment stage failed" >> $GITHUB_STEP_SUMMARY
            PIPELINE_FAILED=true
          fi
          
          # Check if quality gate failed (this should block deployment)
          if [ "${{ needs.quality-gate.result }}" == "failure" ]; then
            echo "ðŸ›‘ **PIPELINE FAILED**: Quality gate failed" >> $GITHUB_STEP_SUMMARY
            PIPELINE_FAILED=true
          fi
          
          # Check if deployment was skipped due to quality gate failure
          if [ "${{ needs.deployment-stage.result }}" == "skipped" ] && [ "${{ needs.quality-gate.outputs.gate_passed }}" != "true" ]; then
            echo "ðŸ›‘ **PIPELINE FAILED**: Deployment skipped due to quality gate failure" >> $GITHUB_STEP_SUMMARY
            PIPELINE_FAILED=true
          fi
          
          # Exit with error if pipeline failed
          if [ "$PIPELINE_FAILED" = "true" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âŒ **PIPELINE EXECUTION FAILED** - Critical issues must be resolved" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi